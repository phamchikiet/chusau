<div class="!flex flex-col flex-auto min-w-0 relative bg-white">
  <div class="relative flex flex-col  items-center p-3">
    <div class="text-center text-xl font-bold">Danh Sách Thiết Bị</div>
    <div class="p-4 w-full flex flex-row space-x-2 items-center">
      <mat-form-field appearance="outline" class="text-xs">
        <mat-label>Tìm Kiếm</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Tìm Kiếm" #input>
      </mat-form-field>
      <div class="lg:hidden flex cursor-pointer">
        <mat-menu #menu="matMenu">
          <button mat-menu-item>
            <div (click)="writeExcelFile()" class="flex flex-row space-x-2 items-center justify-center">
              <span class="material-symbols-outlined text-xl" matTooltip="Upload File">file_download</span>
              <span class="text-xs">Download</span>
            </div>
          </button>
          <button mat-menu-item>
            <div (click)="uploadfile.click()" class="flex flex-row space-x-2 items-center justify-center">
              <span class="material-symbols-outlined text-xl" matTooltip="Upload File">file_upload</span>
              <span class="text-xs">Upload</span>
              <input class="hidden" (change)="readExcelFile($event)" type="file" #uploadfile>
            </div>
          </button>
          <button mat-menu-item>
            <div (click)="LoadDrive()" class="flex flex-row space-x-2 items-center justify-center">
              <span class="material-symbols-outlined text-xl" matTooltip="Drive">cloud_download</span>
              <span class="text-xs">Drive ({{SanphamsDrive.length||0}})</span> 
            </div>
          </button>
            <button mat-menu-item *ngIf="SanphamsDrive.length>0">
              <div (click)="SyncDrive()"
              class="flex flex-col items-center p-2 text-center justify-center hover:bg-gray-200 rounded-lg">
              <span class="material-symbols-outlined text-xl" matTooltip="Drive">cloud_sync</span>
              <span class="text-xs">Sync ({{FilterLists.length||0}}/{{SanphamsDrive.length||0}})</span>
            </div>
            </button>
        </mat-menu>
      </div>
      <div class="hidden lg:flex flex-row space-x-3 cursor-pointer">
        <div 
          class="flex flex-col items-center p-2 hover:bg-gray-200 rounded-lg">
          <span class="material-symbols-outlined text-xl" matTooltip="Upload File">file_download</span>
          <span class="text-xs">Download</span>
        </div>
        <div (click)="uploadfile.click()"
          class="flex flex-col items-center p-2 hover:bg-gray-200 rounded-lg">
          <span class="material-symbols-outlined text-xl" matTooltip="Upload File">file_upload</span>
          <span class="text-xs">Upload</span>
          <input class="hidden"  type="file" #uploadfile>
        </div>
        <div (click)="LoadDrive()"
          class="flex flex-col items-center p-2 text-center justify-center hover:bg-gray-200 rounded-lg">
          <span class="material-symbols-outlined text-xl" matTooltip="Drive">cloud_download</span>  
          <span class="text-xs">Drive ({{SanphamsDrive.length||0}})</span>           
        </div>
        <div  (click)="SyncDrive()" *ngIf="SanphamsDrive.length>0"
        class="flex flex-col items-center p-2 text-center justify-center hover:bg-gray-200 rounded-lg">
        <span class="material-symbols-outlined text-xl" matTooltip="Drive">cloud_sync</span>
        <span class="text-xs">Sync ({{Listdata.length||0}}/{{SanphamsDrive.length||0}})</span>
      </div>
        <div (click)="openDialog(dialogXoaBaiviet);Detail={}"
        class="flex flex-col items-center p-2 text-center justify-center hover:bg-gray-200 rounded-lg">
        <span class="material-symbols-outlined text-xl" matTooltip="Drive">add_circle</span>
        <span class="text-xs">Thêm Mới</span>
      </div>
      </div>
    </div>
  </div>
  <div class="relative h-full w-full overflow-auto flex flex-col">
    <div class="mat-elevation-z8 w-full overflow-auto">
      <table mat-table [dataSource]="dataSource" matSort class="w-full min-w-[768px]">
        <ng-container matColumnDef="qrcode">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> QR Code </th>
          <td mat-cell *matCellDef="let row" (click)="openZoomDialog(dialogZoomQR,row)">
            <qrcode [qrdata]="row.id" [allowEmptyString]="true" [cssClass]="'center'" [colorDark]="'#000000ff'"
              [colorLight]="'#ffffffff'" [elementType]="'canvas'" [errorCorrectionLevel]="'M'" [margin]="4" [scale]="1"
              [width]="100"></qrcode>
          </td>
        </ng-container>
        <ng-container matColumnDef="hinhanh">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Hình Ảnh </th>
          <td mat-cell *matCellDef="let row">
            <img [src]="row.Hinhanh" width="100px">
          </td>
        </ng-container>
        <ng-container matColumnDef="Tieude">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Tiêu đề </th>
          <td mat-cell *matCellDef="let row" (click)="openDialog(dialogXoaBaiviet);Detail=row"> {{row.Tieude}} </td>
        </ng-container>
        <ng-container matColumnDef="Mota">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Mô Tả </th>
          <td mat-cell *matCellDef="let row"> {{row.Mota}} </td>
        </ng-container>
        <ng-container matColumnDef="Tinhtrang">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Tình Trạng </th>
          <td mat-cell *matCellDef="let row"> {{row.Tinhtrang}} </td>
        </ng-container>
        <ng-container matColumnDef="HSD">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Hạn Sử Dụng </th>
          <td mat-cell *matCellDef="let row">
            <div class="flex flex-col space-y-3">
              <div>{{row.HSDGio}} Giờ
                {{row.HSDNgay}} Ngày
                {{row.HSDThang}} Tháng
                {{row.HSDNam}} Năm
              </div>
              <div class="w-1/2">
                <mat-progress-bar matTooltip="{{GetPercent(row.NgayHSD,row.Ngaytao).time}}%"
                  [color]="GetPercent(row.NgayHSD,row.Ngaytao).color" mode="determinate"
                  [value]="GetPercent(row.NgayHSD,row.Ngaytao).time"></mat-progress-bar>
                <div>{{GetPercent(row.NgayHSD,row.Ngaytao).time}}%</div>
              </div>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="NgayHSD">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Ngày Hết Hạn </th>
          <td mat-cell *matCellDef="let row"> {{row.NgayHSD|date:'hh:mm:ss dd/MM/yyyy'}} </td>
        </ng-container>
        <ng-container matColumnDef="Ngaytao">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Ngày Tạo </th>
          <td mat-cell *matCellDef="let row"> {{row.Ngaytao|date:'hh:mm:ss dd/MM/yyyy'}} </td>
        </ng-container>
        <ng-container matColumnDef="Action">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Xoá </th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button class="bg-red-400 hover:bg-red-600 text-white" (click)="DeleteThietbi(row)"><span
                class="material-icons">delete</span></button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;">
        </tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="4">Không Tìm Thấy "{{input.value}}"</td>
        </tr>
      </table>
      <mat-paginator (page)="onPageChange($event)" 
      pageSize="10"
      [length]="Total"  
      [pageSizeOptions]="pageSizeOptions"></mat-paginator>
    </div>
  </div>
</div>

<ng-template #dialogXoaBaiviet>
  <div mat-dialog-title class="text-center">
    <ng-container *ngIf="!Detail.id; else elseTemplate">
      Thêm Thiết Bị
    </ng-container>
    <ng-template #elseTemplate>
      Cập Nhật Thiết BỊ
    </ng-template>
  </div>
  <div mat-dialog-content class="text-center">
    <div class="flex lg:flex-row flex-col lg:space-x-3 max-full">
      <div class="flex flex-col space-y-3">
        <webcam [height]="384" [width]="384" (imageCapture)="handleImage($event)" [trigger]="triggerObservable">
        </webcam>
        <div class="snapshot" *ngIf="webcamImage">
          <img [src]="webcamImage.imageAsDataUrl" class="w-96" />
        </div>
        <div>
          <button mat-stroked-button (click)="triggerSnapshot()">Chụp Hình</button>
        </div>
      </div>
      <div class="flex flex-col w-full space-y-3">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Tiêu Đề</mat-label>
          <input class="w-full" matInput [(ngModel)]="Detail.Tieude" [ngModelOptions]="{standalone: true}"
            placeholder="Tiêu Đề">
        </mat-form-field>
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Mô Tả</mat-label>
          <input class="w-full" matInput [(ngModel)]="Detail.Mota" [ngModelOptions]="{standalone: true}"
            placeholder="Mô Tả">
        </mat-form-field>
        <div class="grid grid-cols-2 gap-2">
          <mat-form-field appearance="outline">
            <mat-label>Giờ</mat-label>
            <input matInput [(ngModel)]="Detail.HSDGio" [ngModelOptions]="{standalone: true}" placeholder="Giờ">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Ngày</mat-label>
            <input matInput [(ngModel)]="Detail.HSDNgay" [ngModelOptions]="{standalone: true}" placeholder="Ngày">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Tháng</mat-label>
            <input matInput [(ngModel)]="Detail.HSDThang" [ngModelOptions]="{standalone: true}" placeholder="Tháng">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Năm</mat-label>
            <input matInput [(ngModel)]="Detail.HSDNam" [ngModelOptions]="{standalone: true}" placeholder="Năm">
          </mat-form-field>
        </div>
      </div>
    </div>

  </div>
  <div mat-dialog-actions class="justify-center">
    <button mat-button class="bg-red-400 hover:bg-red-600 text-white" mat-dialog-close="false">Huỷ</button>
    <ng-container *ngIf="Detail.id; else elseTemplate1">
      <button mat-button class="bg-blue-400 hover:bg-blue-600 text-white" mat-dialog-close="true"
        (click)="UpdateThietbi(Detail)">Cập Nhật</button>
    </ng-container>
    <ng-template #elseTemplate1>
      <button mat-button class="bg-blue-400 hover:bg-blue-600 text-white" mat-dialog-close="true"
        (click)="CreateThietbi(Detail)">Đồng Ý</button>
    </ng-template>
  </div>
</ng-template>


<ng-template #dialogZoomQR>
  <div mat-dialog-title class="text-center">
  </div>
  <div mat-dialog-content class="text-center">
    <div class="flex flex-col max-full items-center justify-center">
      <qrcode [qrdata]="SelectItem.id" [allowEmptyString]="true" [cssClass]="'center'" [colorDark]="'#000000ff'"
      [colorLight]="'#ffffffff'" [title]="SelectItem.Tieude" [elementType]="'canvas'" [errorCorrectionLevel]="'M'" [margin]="4" [scale]="1"
      [width]="400"></qrcode>
      <span>{{SelectItem.Tieude}}</span>
    </div>
  </div>
  <div mat-dialog-actions class="justify-center">
    <button mat-button class="bg-red-400 hover:bg-red-600 text-white" mat-dialog-close="false">Đóng</button>
  </div>
</ng-template>